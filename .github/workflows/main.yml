name: Build aligned native libs (16KB)

on:
  workflow_dispatch:
    inputs:
      build_aria2:
        description: "Build aria2 debs"
        required: false
        default: 'true'
        type: choice
        options: ['true','false']
      build_python:
        description: "Build Python debs"
        required: false
        default: 'true'
        type: choice
        options: ['true','false']
      stage_only:
        description: "Skip builds; only stage ZIPs from artifacts"
        required: false
        default: 'false'
        type: choice
        options: ['true','false']
      reuse_run_id:
        description: "Optional run id to reuse deb artifacts from"
        required: false
        type: string

# Allow multiple runs; we prefer reliability over cancellation
concurrency:
  group: 16kb-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-ffmpeg:
    name: Build FFmpeg (arm64, direct NDK)
    runs-on: ubuntu-latest
    timeout-minutes: 240
    if: false
    env:
      API: 21
      EXTRA_LDFLAGS: "-Wl,-z,max-page-size=16384 -Wl,-z,common-page-size=16384"
      CCACHE_DIR: ${{ github.workspace }}/.ccache
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y curl tar xz-utils pkg-config build-essential git nasm yasm llvm ccache

      - name: Set up Java (for sdkmanager)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK r27
        run: |
          yes | sdkmanager --licenses >/dev/null || true
          sdkmanager --install "ndk;27.0.12077973" "platform-tools" "platforms;android-34" || true
          echo "ANDROID_NDK=$ANDROID_SDK_ROOT/ndk/27.0.12077973" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/27.0.12077973" >> $GITHUB_ENV

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ffmpeg-ccache-${{ runner.os }}-${{ hashFiles('.github/workflows/main.yml') }}
          restore-keys: |
            ffmpeg-ccache-${{ runner.os }}-

      - name: Download FFmpeg source (shallow)
        run: |
          curl -L -o ffmpeg.tar.xz https://ffmpeg.org/releases/ffmpeg-6.1.1.tar.xz
          mkdir ffmpeg-src && tar -xf ffmpeg.tar.xz -C ffmpeg-src --strip-components=1

      - name: Configure (aarch64, minimal, shared)
        working-directory: ffmpeg-src
        env:
          ANDROID_NDK: ${{ env.ANDROID_NDK }}
        run: |
          export NDK=${ANDROID_NDK:-$ANDROID_NDK_ROOT}
          export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64
          export TARGET=aarch64-linux-android
          export API=${API}
          export CC="$TOOLCHAIN/bin/${TARGET}${API}-clang"
          export CXX="$TOOLCHAIN/bin/${TARGET}${API}-clang++"
          export AR=$TOOLCHAIN/bin/llvm-ar
          export LD=$TOOLCHAIN/bin/ld.lld
          export STRIP=$TOOLCHAIN/bin/llvm-strip
          export NM=$TOOLCHAIN/bin/llvm-nm
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export PKG_CONFIG=false
          export CFLAGS="-fPIC -O2"
          export LDFLAGS="${LDFLAGS:-} ${EXTRA_LDFLAGS}"
          ./configure \
            --target-os=android \
            --arch=aarch64 \
            --enable-cross-compile \
            --cc="$CC" \
            --cxx="$CXX" \
            --ar="$AR" \
            --nm="$NM" \
            --ranlib="$RANLIB" \
            --strip="$STRIP" \
            --pkg-config=false \
            --prefix=/data/youtubedl-android/usr \
            --enable-shared \
            --disable-static \
            --disable-doc \
            --disable-debug \
            --enable-small \
            --disable-autodetect \
            --enable-ffmpeg \
            --enable-ffprobe \
            --disable-ffplay \
            --disable-postproc \
            --disable-avdevice \
            --disable-filters \
            --disable-network \
            --disable-muxers \
            --disable-encoders \
            --disable-decoders \
            --disable-demuxers \
            --disable-parsers \
            --enable-muxer=mp4,matroska,webm,segment,concat,adts \
            --enable-demuxer=mov,matroska,webm,mp3,mp4,ogg,flv,mpegts \
            --enable-parser=aac,h264,hevc,opus,vorbis,mp3 \
            --enable-decoder=aac,h264,hevc,opus,vorbis,mp3 \
            --enable-protocol=file,pipe,concat

      - name: Build
        working-directory: ffmpeg-src
        run: |
          make -j$(nproc)
          make install DESTDIR=$GITHUB_WORKSPACE/out/ffmpeg-install || true

      - name: Stage outputs
        run: |
          mkdir -p out/jniLibs/arm64-v8a
          # Package installed libs similar to Termux structure for yt-dlp wrapper
          if [ -d out/ffmpeg-install/data/youtubedl-android/usr ]; then
            (cd out/ffmpeg-install && zip --symlinks -r $GITHUB_WORKSPACE/out/libffmpeg.zip data/youtubedl-android/usr)
            cp $GITHUB_WORKSPACE/out/libffmpeg.zip out/jniLibs/arm64-v8a/libffmpeg.zip.so
          fi
          # Ship executables as .so (matches existing packaging convention)
          if [ -f ffmpeg-src/ffmpeg ]; then cp ffmpeg-src/ffmpeg out/jniLibs/arm64-v8a/libffmpeg.so; fi
          if [ -f ffmpeg-src/ffprobe ]; then cp ffmpeg-src/ffprobe out/jniLibs/arm64-v8a/libffprobe.so; fi

      - name: Upload FFmpeg artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-arm64
          path: out/jniLibs/arm64-v8a
          if-no-files-found: error

  build-aria2:
    name: Build aria2 (arm64)
    runs-on: ubuntu-latest
    timeout-minutes: 360
    if: ${{ inputs.stage_only != 'true' && inputs.build_aria2 == 'true' }}
    env:
      TERMUX_ARCH: aarch64
      TERMUX_PREFIX: /data/youtubedl-android/usr
      TERMUX_ANDROID_HOME: /data/youtubedl-android/home
      MAKEFLAGS: "-j$(nproc)"
      EXTRA_LDFLAGS: "-Wl,-z,max-page-size=16384 -Wl,-z,common-page-size=16384"
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y zip unzip dpkg-dev binutils llvm
          docker --version || true

      - name: Restore caches
        uses: actions/cache@v4
        with:
          path: |
            termux-packages/.termux-build
            termux-packages/debs
            termux-packages/.cache
          key: aria2-${{ runner.os }}-${{ hashFiles('.github/workflows/main.yml') }}
          restore-keys: |
            aria2-${{ runner.os }}-

      - name: Clone Termux packages (shallow)
        run: |
          if [ ! -d termux-packages ]; then
            git clone --depth 1 https://github.com/termux/termux-packages.git
          fi

      - name: Build aria2
        working-directory: termux-packages
        run: |
          cat > build-aria2.sh << 'EOS'
          #!/usr/bin/env bash
          set -euxo pipefail
          export TERMUX_ARCH=${TERMUX_ARCH}
          export TERMUX_PREFIX=${TERMUX_PREFIX}
          export TERMUX_ANDROID_HOME=${TERMUX_ANDROID_HOME}
          export MAKEFLAGS=${MAKEFLAGS}
          export LDFLAGS="${LDFLAGS:-} ${EXTRA_LDFLAGS}"
          ./scripts/run-docker.sh env TERMUX_ARCH=${TERMUX_ARCH} TERMUX_PREFIX=${TERMUX_PREFIX} TERMUX_ANDROID_HOME=${TERMUX_ANDROID_HOME} LDFLAGS="${LDFLAGS}" ./build-package.sh aria2
          EOS
          chmod +x build-aria2.sh
          ./build-aria2.sh

      - name: List built aria2 debs
        run: |
          echo "Listing debs after aria2 build:"
          ls -la termux-packages/debs || true

      - name: Upload aria2 deb artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aria2-debs
          path: termux-packages/debs
          if-no-files-found: error

  build-python:
    name: Build Python (arm64)
    runs-on: ubuntu-latest
    timeout-minutes: 360
    if: ${{ inputs.stage_only != 'true' && inputs.build_python == 'true' }}
    env:
      TERMUX_ARCH: aarch64
      TERMUX_PREFIX: /data/youtubedl-android/usr
      TERMUX_ANDROID_HOME: /data/youtubedl-android/home
      MAKEFLAGS: "-j$(nproc)"
      EXTRA_LDFLAGS: "-Wl,-z,max-page-size=16384 -Wl,-z,common-page-size=16384"
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y zip unzip dpkg-dev binutils llvm
          docker --version || true

      - name: Restore caches
        uses: actions/cache@v4
        with:
          path: |
            termux-packages/.termux-build
            termux-packages/debs
            termux-packages/.cache
          key: python-${{ runner.os }}-${{ hashFiles('.github/workflows/main.yml') }}
          restore-keys: |
            python-${{ runner.os }}-

      - name: Clone Termux packages (shallow)
        run: |
          if [ ! -d termux-packages ]; then
            git clone --depth 1 https://github.com/termux/termux-packages.git
          fi

      - name: Build Python
        working-directory: termux-packages
        run: |
          cat > build-python.sh << 'EOS'
          #!/usr/bin/env bash
          set -euxo pipefail
          export TERMUX_ARCH=${TERMUX_ARCH}
          export TERMUX_PREFIX=${TERMUX_PREFIX}
          export TERMUX_ANDROID_HOME=${TERMUX_ANDROID_HOME}
          export MAKEFLAGS=${MAKEFLAGS}
          export LDFLAGS="${LDFLAGS:-} ${EXTRA_LDFLAGS}"
          ./scripts/run-docker.sh env TERMUX_ARCH=${TERMUX_ARCH} TERMUX_PREFIX=${TERMUX_PREFIX} TERMUX_ANDROID_HOME=${TERMUX_ANDROID_HOME} LDFLAGS="${LDFLAGS}" ./build-package.sh python
          EOS
          chmod +x build-python.sh
          ./build-python.sh

      - name: List built Python debs
        run: |
          echo "Listing debs after Python build:"
          ls -la termux-packages/debs || true

      - name: Upload Python deb artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-debs
          path: termux-packages/debs
          if-no-files-found: error

  stage-aria2-zip:
    name: Stage aria2 ZIP
    runs-on: ubuntu-latest
    needs: [build-aria2]
    if: ${{ inputs.stage_only != 'true' }}
    steps:
      - uses: actions/checkout@v4
      - name: Download aria2 deb artifacts
        uses: actions/download-artifact@v4
        with:
          name: aria2-debs
          path: _aria2_debs
      - name: Create aria2 ZIP
        run: |
          set -euxo pipefail
          mkdir -p $GITHUB_WORKSPACE/out/aria2
          find _aria2_debs -type f -name "*.deb" -exec dpkg-deb -x {} $GITHUB_WORKSPACE/out/aria2 \;
          cd $GITHUB_WORKSPACE/out/aria2
          for prefix in data/youtubedl-android/usr data/data/com.termux/files/usr data/usr usr; do
            if [ -d "$prefix/lib" ]; then
              (cd "$(dirname "$prefix")" && zip --symlinks -r $GITHUB_WORKSPACE/out/libaria2c.zip "$(basename "$prefix")"/lib)
              break
            fi
          done
          [ -f $GITHUB_WORKSPACE/out/libaria2c.zip ]
      - name: Upload aria2 artifact
        uses: actions/upload-artifact@v4
        with:
          name: aria2-arm64
          path: out/libaria2c.zip
          if-no-files-found: error
          retention-days: 14

  stage-python-zip:
    name: Stage Python ZIP
    runs-on: ubuntu-latest
    needs: [build-python]
    if: ${{ inputs.stage_only != 'true' }}
    steps:
      - uses: actions/checkout@v4
      - name: Download Python deb artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-debs
          path: _python_debs
      - name: Create Python ZIP
        run: |
          set -euxo pipefail
          mkdir -p $GITHUB_WORKSPACE/out/python
          find _python_debs -type f -name "*.deb" -exec dpkg-deb -x {} $GITHUB_WORKSPACE/out/python \;
          cd $GITHUB_WORKSPACE/out/python
          for prefix in data/youtubedl-android/usr data/data/com.termux/files/usr data/usr usr; do
            if [ -d "$prefix/lib" ]; then
              (cd "$(dirname "$prefix")" && zip --symlinks -r $GITHUB_WORKSPACE/out/libpython.zip "$(basename "$prefix")"/lib)
              break
            fi
          done
          [ -f $GITHUB_WORKSPACE/out/libpython.zip ]
      - name: Upload Python artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-arm64
          path: out/libpython.zip
          if-no-files-found: error
          retention-days: 14

  stage-aria2-zip-reuse:
    name: Stage aria2 ZIP (reuse artifacts)
    runs-on: ubuntu-latest
    if: ${{ inputs.stage_only == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - name: Download aria2 deb artifacts from run
        uses: actions/download-artifact@v4
        with:
          name: aria2-debs
          path: _aria2_debs
          run-id: ${{ inputs.reuse_run_id }}
      - name: Create aria2 ZIP
        run: |
          set -euxo pipefail
          mkdir -p $GITHUB_WORKSPACE/out/aria2
          find _aria2_debs -type f -name "*.deb" -exec dpkg-deb -x {} $GITHUB_WORKSPACE/out/aria2 \;
          cd $GITHUB_WORKSPACE/out/aria2
          for prefix in data/youtubedl-android/usr data/data/com.termux/files/usr data/usr usr; do
            if [ -d "$prefix/lib" ]; then
              (cd "$(dirname "$prefix")" && zip --symlinks -r $GITHUB_WORKSPACE/out/libaria2c.zip "$(basename "$prefix")"/lib)
              break
            fi
          done
          [ -f $GITHUB_WORKSPACE/out/libaria2c.zip ]
      - name: Upload aria2 artifact
        uses: actions/upload-artifact@v4
        with:
          name: aria2-arm64
          path: out/libaria2c.zip
          if-no-files-found: error
          retention-days: 14

  stage-python-zip-reuse:
    name: Stage Python ZIP (reuse artifacts)
    runs-on: ubuntu-latest
    if: ${{ inputs.stage_only == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - name: Download Python deb artifacts from run
        uses: actions/download-artifact@v4
        with:
          name: python-debs
          path: _python_debs
          run-id: ${{ inputs.reuse_run_id }}
      - name: Create Python ZIP
        run: |
          set -euxo pipefail
          mkdir -p $GITHUB_WORKSPACE/out/python
          find _python_debs -type f -name "*.deb" -exec dpkg-deb -x {} $GITHUB_WORKSPACE/out/python \;
          cd $GITHUB_WORKSPACE/out/python
          for prefix in data/youtubedl-android/usr data/data/com.termux/files/usr data/usr usr; do
            if [ -d "$prefix/lib" ]; then
              (cd "$(dirname "$prefix")" && zip --symlinks -r $GITHUB_WORKSPACE/out/libpython.zip "$(basename "$prefix")"/lib)
              break
            fi
          done
          [ -f $GITHUB_WORKSPACE/out/libpython.zip ]
      - name: Upload Python artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-arm64
          path: out/libpython.zip
          if-no-files-found: error
          retention-days: 14
